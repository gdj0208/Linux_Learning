# ì‹œìŠ¤í…œ Vì˜ í”„ë¡œì„¸ìŠ¤ ê°„ í†µì‹ 

## 1ï¸âƒ£ ì‹œìŠ¤í…œ V IPC

### ğŸ¯ ì‹œìŠ¤í…œ V IPC
- ìœ ë‹‰ìŠ¤ëŠ” BSDê³„ì—´ê³¼ ì‹œíŠ¸í…œV ê³„ì—´ë¡œ êµ¬ë¶„ë¨
- ì‹œìŠ¤í…œ V IPC : ë©”ì‹œì§€í + ê³µìœ  ë©”ëª¨ë¦¬ + ì„¸ë§ˆí¬ì–´
- ì‹œìŠ¤í…œ V ê³„ì—´ ìœ ë‹‰ìŠ¤ì—ì„œ ê°œë°œí•´ ì œê³µí•˜ëŠ” í”„ë¡œì„¸ìŠ¤ ê°„ í†µì‹ ë²•


### ğŸ¯ IPC ê°ì²´
- ì‹œìŠ¤í…œ V IPCë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ IPC ê°ì²´ë¥¼ ìƒì„±í•´ì•¼í•¨
- IPC ê°ì²´ ìƒì„±ì„ ìœ„í•´ **í‚¤**ì™€ **ì‹ë³„ì** ì‚¬ìš©

**[ IPC ê°ì²´ ê´€ë¦¬ ëª…ë ¹ ]**
```c
IPC_PRIVATE
key_t ftok(const char *pathname, int proj_id);
```
```bash
ipcs            # IPC ì •ë³´ ê²€ìƒ‰
ipcmk [options] # IPC ìƒì„±
ipcrm [options] # IPC ì‚­ì œ
```



### ğŸ¯ ë©”ì‹œì§€ í 
**[ íŠ¹ì„œ ]**
- íŒŒì´í”„ì™€ ìœ ì‚¬
- ë©”ì‹œì§€(íŒ¨í‚·) ë‹¨ìœ„ë¡œ ë™ì‘
- ìš°í¸í•¨ì²˜ëŸ¼ ë©”ì‹œì§€ íë¥¼ ë§Œë“  ë‹¤ìŒ ì´ë¡œ ë©”ì‹œì§€ë¥¼ ì£¼ê³  ë°›ìŒ

**[ ì˜ˆì‹œ ì½”ë“œ ]**
```c
int msgget(key_t key, int msgflg);                                  // ë©”ì‹œì§€ í ì‹ë³„ì ìƒì„±
int msgsnd(int msqid, const void *msgp, size_t msgsz, int msgflg);  // ë©”ì‹œì§€ ì „ì†¡
ssize_t msgrcv(int msqid, void *msgp, size_t msgsz, long msgtyp, int msgflg) // ë©”ì‹œì§€ ìˆ˜ì‹ 
int msgctl(int msqid, int cmd, struct msqid_ds *buf)                // ë©”ì‹œì§€ ì œì–´
```



### ğŸ¯ ê³µìœ  ë©”ëª¨ë¦¬
**[ ê³µìœ  ë©”ëª¨ë¦¬ í•¨ìˆ˜ ]**
- í•œ í”„ë¡œì„¸ìŠ¤ì˜ ì¼ë¶€ë¶„ë“¤ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ì™€ ê³µìœ 
- ë©”ëª¨ë¦¬ì˜ ì¼ë¶€ ê³µê°„ì„ ë‘ ë…ë¦½ì ì¸ í”„ë¡œì„¸ìŠ¤ ê³µìœ  -> í•´ë‹¹ ë©”ëª¨ë¦¬ë¥¼ í†µí•´ ë°ì´í„°ë¥¼ ì£¼ê³  ë°›ìŒ

**[ ê³µìœ  ë©”ëª¨ë¦¬ í•¨ìˆ˜ ]**
```c
int shmget(key_t key, size_t size, int shmflg);             // ê³µìœ  ë©”ëª¨ë¦¬ ì‹ë³„ì ìƒì„±
void *shmat(int shmid, const void *shmaddr, int shmflg);    // ê³µìœ  ë©”ëª¨ë¦¬ ì—°ê²°
int shmdt(const void *shmaddr);                             // ê³µìœ  ë©”ëª¨ë¦¬ ì—°ê²° í•´ì œ
int shmctl(int shmid, int cmd, struct shmid_ds *bug);       // ê³µìœ  ë©”ëª¨ë¦¬ ì œì–´
```


### ğŸ¯ ì„¸ë§ˆí…ì–´
**[ ì„¸ë§ˆí¬ì–´ ì •ì˜ ]**
- í”„ë¡œì„¸ìŠ¤ ì‚¬ì´ì˜ ë™ê¸°ë¥¼ ë§ì¶”ëŠ” ê¸°ëŠ¥
- ê³µìœ  ë©”ëª¨ë¦¬ì— ì—¬ëŸ¬ í”„ë¡œì„¸ìŠ¤ê°€ ë™ì‹œì— ì“°ê¸°ë¥¼ ì‹œë„í•˜ë©´ ë°ì´í„° ì†ìƒ
- ì„¸ë§ˆ í¬ì–´ê°€ ë³µìˆ˜ì˜ í”„ë¡œì„¸ìŠ¤ ì‚¬ì´ì— ë™ì‘ ìˆœì„œë¥¼ ì œê³µ

**[ ì„¸ë§ˆí¬ì–´ í•¨ìˆ˜ ]**
```c
int semget(key_t key, int nsems, int semflg);               // ì„¸ë§ˆí¬ì–´ ìƒì„±
int semctl(int semid, int semnum, int cmd, ...);            // ì„¸ë§ˆí¬ì–´ ì œì–´
int semop(int semid, struct sembuf *sops, size_t nsops);    // ì„¸ë§ˆí¬ì–´ ì—°ì‚°
```





## 2ï¸âƒ£ì‹œìŠ¤í…œ V IPCì˜ ê³µí†µ ìš”ì†Œ

### ğŸ¯ í‚¤ì™€ ì‹ë³„ì
1. í‚¤ë¡œ `IPC_PIVATE` ì§€ì •
    - ìƒì„±ëœ ì‹ë³„ìë¥¼ ì„œë²„ì™€ í´ë¼ì´ì–¸íŠ¸ ëª¨ë‘ ì•Œ ìˆ˜ ìˆê²Œ ìƒì„±
    - `fork()`ë¡œ ìƒì„±ëœ ë¶€ëª¨-ìì‹ í”„ë¡œì„¸ìŠ¤ ê°„ í†µì‹ ì—ì„œ ìœ ìš©í•˜ê²Œ ì‚¬ìš©

2. `ftok()`ë¡œ í‚¤ ìƒì„±
    - ê²½ë¡œëª…ê³¼ ìˆ«ìê°’ì„ ë°›ì•„ì„œ keyë¥¼ ìƒì„±
    - ì„œë²„ì™€ í´ë¼ì´ì–¸íŠ¸ê°€ ê°™ì€ ê²½ë¡œëª…ê³¼ ìˆ«ìê°’ì„ ì§€ì •í•˜ë©´ ê³µí†µ ì‹ë³„ì ìƒì„± ê°€ëŠ¥

3. key ìƒì„±ì˜ ì£¼ì˜ ì‚¬í•­
    - ê°™ì€ í‚¤ë¡œ ìƒì„±ëœ ì‹ë³„ìëŠ” í†µì‹ ì— ì‚¬ìš©í•  ìˆ˜ ìˆìŒ
    - ë¯¸ë¦¬ ì •í•´ì§„ keyë¥¼ ì„œë²„ì™€ í´ë¼ì´ì–¸íŠ¸ í”„ë¡œì„¸ìŠ¤ê°€ ê³µìœ 



### ğŸ¯ í‚¤ ìƒì„±í•˜ê¸° : ftok()
**[ ì½”ë“œ ]**
```c
#include <sys/types.h>
#include <sys/ipc.h>

key_t ftok(const char *pathname, int proj_id);
```
- `pathname` : íŒŒì¼ ì‹œìŠ¤í…œì— ì§€ì •í•œ ê²½ë¡œëª…ê³¼ `proj_id`ì— ì§€ì •ëœ ì •ìˆ«ê°’ì„ ì¡°í•©í•´ `key`ë¥¼ ìƒì„± 
    - ê²½ë¡œëª… + ì ‘ê·¼ ê¶Œí•œ í•„ìš”
- `proj_id` : `key`ê°’ì„ ìƒì„±í•  ë•Œ ì§€ì •í•˜ëŠ” ì„ì˜ì˜ ë²ˆí˜¸

**[ IPC ê³µí†µ êµ¬ì¡°ì²´ ]**
```c
struct ipc_perm {
    key_t key;              // key ê°’
    uid_t uid;              // êµ¬ì¡°ì²´ ì†Œìœ ì ID
    gid_t gid;              // êµ¬ì¡°ì²´ ì†Œìœ  ê·¸ë£¹ ID
    uid_t cuid;             // êµ¬ì¡°ì²´ë¥¼ ìƒì„±í•œ ì†Œìœ ì ID    
    gid_t cgid;             // êµ¬ì¡°ì²´ë¥¼ ìƒì„±í•œ ê·¸ë£¹ ID
    unsigned short mode;    // êµ¬ì¡°ì²´ì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œ
    unsigned short _seq;    // ì¼ë ¨ ë²ˆí˜¸
}
```


### ğŸ¯ ì‹œìŠ¤í…œ V IPC ì •ë³´ ê²€ìƒ‰
**[ ëª…ë ¹ì˜ ê¸°ë³¸ í˜•ì‹ ]**
- ipcs : ì‹œìŠ¤í…œV IPCì˜ ì •ë³´ë¥¼ ê²€ìƒ‰í•˜ê³  í˜„ì¬ ìƒíƒœë¥¼ í™•ì¸í•˜ëŠ” ëª…ë ¹
- ipcs ëª…ë ¹ì„ ì‹¤í–‰í•˜ëŠ” ë™ì•ˆì—ë„ IPC ìƒíƒœê°€ ë³€ê²½ë  ìˆ˜ ìˆìŒ
- ipcs ëª…ë ¹ì€ ê²€ìƒ‰í•˜ëŠ” ìˆœê°„ì˜ ì •í™•ì„±ë§Œ ë³´ì¥

**[ ì¼ë°˜ ì˜µì…˜ ]**
```bash
-i id   # íŠ¹ì • ìš”ì†Œì— ëŒ€í•œ ì •ë³´ë¥¼ ì¶œë ¥
-h      # ë„ì›€ë§ ì¶œë ¥
-V      # ë²„ì „
```


### ğŸ¯ ì‹œìŠ¤í…œ V IPC ìì›ì˜ ìƒì„±ê³¼ ì‚­ì œ
**[ ipcmk ëª…ë ¹ ]**
```bash
ipcmk [options]
```
- `-M size` : sizeì— ì§€ì •í•œ byte í¬ê¸°ë¡œ ë©”ëª¨ë¦¬ ìƒì„±
- `-Q` : ë©”ì‹œì§€ í ì‘ì„±
- `-S number` : numberì— í•´ë‹¹ë˜ëŠ” ì„¸ë§ˆí¬ì–´ ìƒì„±
- `-p mode` : ìì› ì ‘ê·¼ ê¶Œí•œ (0644)

**[ ipcrm ëª…ë ¹ ]**
```c
ipcrm [options]
```
- `-a` : ëª¨ë“  ìì› ì œê±°
- `-M shmkey` : shmekyë¡œ ìƒì„±í•œ ê³µìœ  ë©”ëª¨ë¦¬ì˜ **ë§ˆì§€ë§‰ ì—°ê²°ì´ í•´ì œ**ëœ í›„ **ê³µìœ ë©”ëª¨ë¦¬ ì œê±°**
- `-m shmid` : shmidë¡œ ì§€ì •í•œ ê³µìœ  ë©”ëª¨ë¦¬ ì‚­ì œ
- `-Q msgkey` : msgkeyë¡œ ìƒì„±í•œ ë©”ì‹œì§€ í ì œê±°
- `-q msgid` : msgidë¡œ ì§€ì •í•œ ë©”ì‹œì§€ í ì‚­ì œ
- `-S semkey` : semkeyë¡œ ìƒì„±í•œ ì„¸ë§ˆí¬ì–´ ì‚­ì œ
- `-s semid` : semidë¡œ ì§€ì •í•œ ì„¸ë§ˆí¬ì–´ ì‚­ì œ





## 3ï¸âƒ£ ë©”ì‹œì§€ í

### ğŸ¯ ë©”ì‹œì§€ í ì‹ë³„ì ìƒì„± : msgget()
**[ ì½”ë“œ ]**
```c
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/msg.h>

int msgget(key_t key, int msgflg);
```
- `key` : ë©”ì‹œì§€ íë¥¼ êµ¬ë³„í•˜ëŠ” key
    - `IPC_PRIVATE` ë˜ëŠ” `ftok()`
- `msgflg` : ë©”ì‹œì§€ íì˜ ì†ì„±ì„ ì„¤ì •í•˜ëŠ” í”Œë˜ê·¸
    - `IPC_CREAT` : ì‹ë³„ìë¥¼ ìƒˆë¡œ ìƒì„±
    - `IPC_EXCEL` : ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í‚¤ë©´ ì˜¤ë¥˜ ë°œìƒ

**[ msqid_ds êµ¬ì¡°ì²´ ]**
```c
struct msqid_ds {
    struct ipc_perm msg_perm;   // IPC ê³µí†µ êµ¬ì¡°ì²´
    time_t msg_stime;           // ë§ˆì§€ë§‰ìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ë³´ë‚¸ ì‹œê°
    time_t msg_rtime;           // ë§ˆì§€ë§‰ìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ì½ì€ ì‹œê°
    time_t msg_ctime;           // ë§ˆì§€ë§‰ìœ¼ë¡œ ë©”ì‹œì§€ íì˜ ê¶Œí•œì„ ë°”ê¾¼ ì‹œê°
    unsigned long __msg_cbytes; // í˜„ ë©”ì‹œì§€ íì— ìˆëŠ” ì´ ë°”ì´íŠ¸ ìˆ˜
    msqnum_t msq_qnum;          // ë©”ì‹œì§€ íì— ìˆëŠ” ë©”ì‹œì§€ ê°œìˆ˜
    msglen_t msg_qbytes;        // ë©”ì‹œì§€ íì˜ ìµœëŒ€ í¬ê¸°
    pid_t msg_lspid;            // ë§ˆì§€ë§‰ìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ë³´ë‚¸ í”„ë¡œì„¸ìŠ¤ì˜ PID
    pid_t msg_lrpid;            // ë§ˆì§€ë§‰ìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ì½ì€ í”„ë¡œì„¸ìŠ¤ì˜ PID
}
```

**[ ì½”ë“œ ì˜ˆì‹œ ]**
```c
key_t key;
int id;

key = ftok("keyfile", 1);
id = msgget(key, IPC_CREAT | 0640);
```


### ğŸ¯ ë©”ì‹œì§€ ì „ì†¡ : mssgsnd()
**[ ì½”ë“œ ]**
```c
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/msg.h>

int msgsnd(int msqid, const void *msgp, size_t msgsz, int msgflg);
```
- `msqid` : msgget í•¨ìˆ˜ë¡œ ìƒì„±í•œ ë©”ì‹œì§€í ì‹ë³„ì
- `msgp` : ë©”ì‹œì§€ë¥¼ ë‹´ê³  ìˆëŠ” ë©”ì‹œì§€ ë²„í¼ì˜ ì£¼ì†Œ
- `msgsz` : ë©”ì‹œì§€ì˜ í¬ê¸°
- `msgflg` : ë¸”ë¡ ëª¨ë“œ(0) / ë¹„ë¸”ë¡ ëª¨ë“œ(IPC_NOWAIT)

**[ msgbuf êµ¬ì¡°ì²´ ]**
```c
struct msgbuf {
    long mtype;     // ë©”ì‹œì§€ ìœ í˜•ìœ¼ë¡œ ì–‘ìˆ˜ë¥¼ ì§€ì •
    char mtext[1];  // msgszë¡œ ì§€ì •í•œ í¬ê¸°ì˜ ë²„í¼ë¡œ ë©”ì‹œì§€ ë‚´ìš©ì´ ì €ì¥
}
```

**[ ë©”ì‹œì§€ íë¥¼ ìƒì„±í•˜ê³  ì „ì†¡í•˜ëŠ” ì˜ˆì‹œ ]**
```c
// e1_client.c
#include <fcntl.h>
#include <unistd.h>
#include <stdlib.h>
#include <stdio.h>

int main() {
    int pd, n;
    char inmsg[80];

    if ((pd = open("./TEST-FIFO", O_RDONLY)) == -1) {
        perror("open");
        exit(1);
    }

    printf("Client =====\n");
    write(1, "From Server :", 13);
    while ((n=read(pd, inmsg, 80)) > 0)
        write(1, inmsg, n);

    if (n == -1) {
        perror("read");
        exit(1);
    }

    write(1, "\n", 1);
    close(pd);
}
```

```c
// e1_server.c
#include <sys/stat.h>
#include <fcntl.h>
#include <unistd.h>
#include <stdlib.h>
#include <stdio.h>
#include <string.h>

int main() {
    int pd, n;
    char msg[] = "Hello, FIFO";

    printf("Server =====\n");

    if (mkfifo("./TEST-FIFO", 0666) == -1) {
        perror("mkfifo");
        exit(1);
    }
    if ((pd = open("./TEST-FIFO", O_WRONLY)) == -1) {
        perror("open");
        exit(1);
    }

    printf("To Client : %s\n", msg);

    n = write(pd, msg, strlen(msg)+1);
    if (n == -1) {
        perror("write");
        exit(1);
    }
    close(pd);
}
```


### ğŸ¯ ë©”ì‹œì§€ ìˆ˜ì‹  : msgrcv()
**[ ì½”ë“œ ]**
```c
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/msg.h>

ssize_t msgrcv(
    int msqid,      // ë©”ì‹œì§€ í ì‹ë³„ì
    void *msgp,     // ë©”ì‹œì§€ ë²„í¼ ì£¼ì†Œ
    size_t msgsz,   // ë©”ì‹œì§€ ë²„í¼ í¬ê¸°
    long msgtyp,    // ì½ì–´ì˜¬ ë©”ì‹œì§€ ìœ í˜•
    int msgflg      // ë¸”ë¡ ëª¨ë“œ(0), ë¹„ë³¼ë¡ ëª¨ë“œ(IPC_NOWAIT)
);
```
- `msgtyp`ì— ì§€ì • ê°€ëŠ¥í•œ ê°’ : ì½ì–´ì˜¬ ë©”ì‹œì§€ ìœ í˜•
    - 0 : ë©”ì‹œì§€ íì˜ ê°€ì¥ ì•ì— ìˆëŠ” ë©”ì‹œì§€
    - ì–‘ìˆ˜ : ë©”ì‹œì§€ íì—ì„œ msgtypë¡œ ì§€ì •í•œ ìœ í˜•ê³¼ ê°™ì€ ë©”ì‹œì§€ë¥¼ ì½ì–´ì˜´
    - ìŒìˆ˜ : ë©”ì‹œì§€ íì—ì„œ msgtypë¡œ ì§€ì •í•œ ê°’ì˜ ì ˆëŒ€ê°’ì´ ê°™ê±°ë‚˜ ì‘ì€ ë©”ì‹œì§€ë¥¼ ì½ì–´ì˜´

**[ ë©”ì‹œì§€ ìˆ˜ì‹  ì˜ˆì‹œ ]**
```c
// e2_client.c
#include <sys/msg.h>
#include <stdlib.h>
#include <stdio.h>
#include <string.h>

struct mymsgbuf {
    long mtype;
    char mtext[80];
};

int main() {
    key_t key;
    int msgid;
    struct mymsgbuf mesg;

    //key = ftok("keyfile", 1);
    msgid = msgget(0777, IPC_CREAT|0644);
    if (msgid == -1) {
        perror("msgget");
        exit(1);
    }

    mesg.mtype = 1;
    strcpy(mesg.mtext, "Message Q Test");

    if (msgsnd(msgid, (void *)&mesg, 80, IPC_NOWAIT) == -1) {
        perror("msgsnd");
        exit(1);
    }
}
```

```c
// e2_server.c
#include <sys/msg.h>
#include <stdlib.h>
#include <stdio.h>

struct mymsgbuf {
    long mtype;
    char mtext[80];
};

int main() {
    struct mymsgbuf inmsg;
    key_t key;
    int msgid, len;

    //key = ftok("keyfile", 1);
    if ((msgid = msgget(0777, 0)) < 0) {
        perror("msgget");
        exit(1);
    }

    len = msgrcv(msgid, &inmsg, 80, 0, 0);
    printf("Received Msg = %s, Len=%d\n", inmsg.mtext, len);
}
```


### ğŸ¯ ë©”ì‹œì§€ ì œì–´ : msgctl
**[ ì½”ë“œ ]**
```c
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/msg.h>

int msgctl(
    int msqid,              // ë©”ì‹œì§€ í ì‹ë³„ì
    int cmd,                // ìˆ˜í–‰í•  ì œì–´ ê¸°ëŠ¥
    struct msqid_ds *buf    // ë©”ì‹œì§€ í êµ¬ì¡°ì²´ì˜ ì£¼ì„œ
);
```
- `cmd` ì§€ì • ê°€ëŠ¥ ëª©ë¡
    - `IPC_STAT` : í˜„ì¬ ë©”ì‹œì§€ íì˜ ì •ë³´ë¥¼ bufë¡œ ì§€ì •í•œ ë©”ëª¨ë¦¬ì— ì €ì¥
    - `IPC_SET` : ë©”ì‹œì§€ í ì •ë³´ê°’ì„ ë³€ê²½
    - `IPC_RMID` : msqidë¡œ ì§€ì •í•œ ë©”ì‹œì§€ í ì œê±°, ê´€ë ¨ëœ ë°ì´í„° êµ¬ì¡°ì²´ ì œê±°
    - `IPC_INFO` : ë©”ì‹œì§€ íì˜ ì œí•œê°’ì„ vufì— ì €ì¥

**[ msginfo êµ¬ì¡°ì²´ ]**
```c
struct msginfo {
    int msgpool;            // ë©”ì‹œì§€ ë°ì´í„°ë¥¼ ì €ì¥í•  ë²„í¼ ê³µê°„ í¬ê¸°
    int msgmap;             // ë©”ì‹œì§€ ë§µì˜ ìµœëŒ€ í•­ëª© ìˆ˜
    int msgmax;             // ë©”ì‹œì§€ì— ì €ì¥í•  ìˆ˜ ìˆëŠ” ë©”ì‹œì§€ì˜ ìµœëŒ€ í¬ê¸°
    int msgmnb;             // ë©”ì‹œì§€ íì— ì‘ì„±í•  ìˆ˜ ìˆëŠ” ìµœëŒ€ í¬ê¸°
    int msgmni;             // ë©”ì‹œì§€ íì˜ ìµœëŒ€ ê°œìˆ˜
    int msgssz;             // ë©”ì‹œì§€ ì„¸ê·¸ë¨¼íŠ¸ í¬ê¸°
    int msgtql;             // ì‹œìŠ¤í…œì— ì‡ëŠ” ëª¨ë“  ë©”ì‹œì§€ íì˜ ìµœëŒ€ ë©”ì‹œì§€ ìˆ˜
    unsigned short msgseq;  // ì„¸ê·¸ë¨¼íŠ¸ ìµœëŒ€ ê°œìˆ˜
}
```

**[ ì˜ˆì‹œ ]**